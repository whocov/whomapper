---
title: "Use of whomapper"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use of whomapper}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 11.8, 
  fig.height = 7.2,
  warning = FALSE
)
```

## Introduction

`whomapper` is a R package internal to WHO, intended to house shapefiles and produce WHO legal maps. While this package can produce legal maps, please note that **the user of this package is responsible for ensuring that any maps they produce fulfill WHO legal standards**. The WHO map SOP can be accessed [here](http://gamapserver.who.int/gho/gis/training/DMF_GIS2010_2_SOPSforWHOMaps.pdf){target="_blank"}.

We start by loading admin 0 shapefiles, and WHO vaccine data for visualisation by country:

```{r setup}
pacman::p_load(tidyverse, whomapper, sf, lubridate)

## we use WHO vaccine data to visualise on a map
vaccine_data <- whomapper:::vaccine_data

## pull in shapefiles for admin 0
sfs <- whomapper::pull_who_adm0()


```


## Producing basic maps at admin 0 level

This package has been set up to allow for flexible use of `ggplot2` for mapping. It's highly recommended that `tidyverse` is installed before using this package to manipulate maps. The basic workflow for using this package is:

1. Read in shapefiles (packaged with `whomapper`)
2. Merge data of interest with the `adm0` list element of the shapefiles (the polygons)
3. Begin a standard ggplot:
    1. Plot shapefiles with `geom_sf_who_poly()`
    2. Define legend aesthetics with `scale_...()`
    3. Define labels for the plot
4. call `who_map_pipeline()` to define disputed areas, theme, legal text etc.
5. Save the plot using `who_map_save()` - This ensures that dimensions are correct. 


Some basic tips for using this package are:

1. Use the `geom_sf_who_poly()` custom geom to plot shapefile **polygons** with default settings (i.e. no border)
2. Legend aesthetics can be controlled as normal with ggplot - here this should be done before calling `who_map_pipeline()` (as in the below examples).
3. The caption, x-axis, and y-axis labels cannot be defined - only the title and subtitle are available.
4. Use `who_map_col()` to define some colours that must be explicit. For example, where there is no data, use `who_map_col("no_data")`

Note that this package can be used to plot maps with continuous, binned, and categorical data. Some examples are shown below.


```{r basic_map}

ggplot() +
  geom_sf_who_poly(data = sfs$adm0, aes(fill = who_region)) +
  scale_fill_brewer(palette = "Set3", 
                    na.value = who_map_col("no_data"),
                    name = "WHO Region") +
  labs(title ="World map by WHO region", 
       subtitle = glue::glue("as of {format(Sys.Date(), '%d %b %y')}")) +
  who_map_pipeline(sf = sfs) 



```

Save the plot:

```{r saving_plot, eval = FALSE}
who_map_save("who_region_map.png", dpi = 700)
```


## Merging data to plot:

As stated previously, data can be merged with shapefiles to plot additional variables:

```{r vaccine_plot }

vaccine_sf <- left_join(
  sfs$adm0,
  vaccine_data %>% select(-report_country, -who_region),
  by = c("iso_3_code" = "iso3")
) %>% 
  mutate(persons_fully_vaccinated_per100 = ifelse(persons_fully_vaccinated_per100 > 100, 100, persons_fully_vaccinated_per100))


ggplot() +
  geom_sf_who_poly(data = vaccine_sf, aes(fill = persons_fully_vaccinated_per100)) +
  scale_fill_fermenter(name = "Fully vaccinated per 100", 
                       palette = "RdYlGn", limits = c(0, 100),
                       direction = 1, na.value = who_map_col("no_data")) +
  labs(title ="Persons fully vaccined per 100, COVID-19", 
       subtitle = str_glue("as of {format(max(vaccine_sf$date_updated, na.rm = TRUE), '%d %b %y')}")) +
  who_map_pipeline(sf = sfs) 



```


## Producing non-global maps  

It is also possible to show produce maps at country or regional level, based on changing the boundaries of the map. For example, to show the same map in the context of SEARO, we can edit the shapefiles to not show data for other countries. We can then zoom into the specified area, either by supplying coordinates, or generating a bounding box and suppling it to `who_map_pipeline()`.

Use of alternative WHO logos is also possible, via the region option in `who_map_pipeline()`

```{r searo map}

vaccine_sf_searo <- vaccine_sf %>% 
  mutate(persons_fully_vaccinated_per100 = ifelse(who_region == "SEARO", persons_fully_vaccinated_per100, NA_real_))

searo_box <- sf::st_bbox(vaccine_sf_searo %>% 
                           filter(who_region == "SEARO"))



ggplot() +
  geom_sf_who_poly(data = vaccine_sf_searo, aes(fill = persons_fully_vaccinated_per100)) +
  scale_fill_fermenter(name = "Fully vaccinated per 100", 
                       palette = "RdYlGn", limits = c(0, 100),
                       direction = 1, na.value = who_map_col("no_data")) +
  labs(title ="Persons fully vaccined per 100, COVID-19", 
       subtitle = str_glue("as of {format(max(vaccine_sf$date_updated, na.rm = TRUE), '%d %b %y')}")) +
  who_map_pipeline(sfs, box_lims = searo_box, region = "searo") 

```

<br> 
<br>

If needs require, it is also possible to change map projections. Note that in doing this, the coordinates of maps are altered, and will need to be controlled for. For example, for a WHO EURO map:

```{r euro map}

sfs_reproj <- map(sfs, ~mutate(.x, geometry = st_transform(geometry, "+proj=laea +lon_0=39.8 +lat_0=34.7")))

box <- sfs_reproj$adm0 %>% 
  filter(who_region == "EURO") %>% 
  st_bbox()


ggplot() +
  geom_sf_who_poly(data = sfs_reproj$adm0, aes(fill = who_region)) +
  scale_fill_brewer(palette = "Set3", 
                    na.value = who_map_col("no_data"),
                    name = "WHO Region") +
  labs(title ="World map by WHO region", 
       subtitle = glue::glue("as of {format(Sys.Date(), '%d %b %y')}")) +
  who_map_pipeline(box_lims = box)


```

